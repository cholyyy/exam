<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商場尋人雷達 Pro</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0a0a0a; color: #00ff00; text-align: center; margin: 0; overflow: hidden; }
        h1 { font-size: 1.2rem; margin-top: 20px; color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        
        /* 雷達樣式 */
        #radar {
            width: 300px; height: 300px; background: radial-gradient(circle, #002200 0%, #000 70%);
            border: 2px solid #00ff00; border-radius: 50%; margin: 30px auto;
            position: relative; overflow: hidden; box-shadow: 0 0 30px rgba(0,255,0,0.3);
        }
        #scanner-line {
            width: 50%; height: 2px; background: linear-gradient(to right, transparent, #00ff00);
            position: absolute; top: 50%; left: 50%; transform-origin: left;
            animation: scan 3s linear infinite;
        }
        #target-dot {
            width: 15px; height: 15px; background: #ff0000; border-radius: 50%;
            position: absolute; top: 50%; left: 50%; display: none;
            box-shadow: 0 0 15px #ff0000; transition: all 0.5s ease;
        }
        #arrow {
            font-size: 50px; color: #fbff00; position: absolute;
            top: 20px; left: 50%; transform: translateX(-50%); display: none;
            text-shadow: 0 0 10px #fbff00;
        }

        /* 控制區 */
        .controls { margin-top: 20px; }
        button {
            padding: 12px 25px; font-size: 1rem; background: transparent;
            color: #00ff00; border: 2px solid #00ff00; border-radius: 5px;
            cursor: pointer; transition: 0.3s;
        }
        button:hover { background: #00ff00; color: #000; }
        #info { margin-top: 15px; font-size: 0.9rem; color: #888; }

        @keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <h1>TARGET RADAR SYSTEM</h1>
    
    <div id="radar">
        <div id="scanner-line"></div>
        <div id="target-dot"></div>
        <div id="arrow">↑</div>
    </div>

    <div class="controls">
        <button onclick="initSystem()">啟動系統</button>
        <div id="info">請點擊按鈕授權藍牙與指南針</div>
        <div id="rssi">RSSI: -- dBm</div>
    </div>

    <script>
        let device, currentHeading = 0;

        async function initSystem() {
            // 1. 請求 iOS 指南針權限 (iOS 13+)
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                const permission = await DeviceOrientationEvent.requestPermission();
                if (permission === 'granted') {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            } else {
                window.addEventListener('deviceorientation', handleOrientation);
            }

            // 2. 啟動藍牙掃描
            try {
                device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
                document.getElementById('info').innerText = `鎖定目標: ${device.name || '未知裝置'}`;
                
                await device.watchAdvertisements();
                device.addEventListener('advertisementreceived', (event) => {
                    const rssi = event.rssi;
                    document.getElementById('rssi').innerText = `RSSI: ${rssi} dBm`;
                    updateRadar(rssi);
                });
            } catch (err) {
                document.getElementById('info').innerText = "錯誤: " + err;
            }
        }

        function handleOrientation(event) {
            // 獲取手機指向的方位角 (0-360)
            currentHeading = event.webkitCompassHeading || (360 - event.alpha);
            document.getElementById('arrow').style.transform = `translateX(-50%) rotate(${-currentHeading}deg)`;
        }

        function updateRadar(rssi) {
            const dot = document.getElementById('target-dot');
            const arrow = document.getElementById('arrow');
            dot.style.display = 'block';
            arrow.style.display = 'block';

            // 將訊號強弱轉化為距離中心點的半徑 (RSSI 約 -100 到 -30)
            const radius = Math.min(140, Math.max(20, (100 + rssi) * 2));
            
            // 注意：藍牙無法得知真實角度，此點位置僅根據訊號強弱在掃描線上擺動
            const x = 150 + radius * Math.cos(Date.now() / 1000);
            const y = 150 + radius * Math.sin(Date.now() / 1000);

            dot.style.left = `${x}px`;
            dot.style.top = `${y}px`;

            if (rssi > -50 && navigator.vibrate) navigator.vibrate(200);
        }
    </script>
</body>
</html>
