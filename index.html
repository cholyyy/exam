<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情侶專屬雷達系統</title>
    <!-- 引入 Firebase -->
    <script src="https://www.gstatic.com"></script>
    <script src="https://www.gstatic.com"></script>
    <!-- 引入 P5.js 畫圖庫 -->
    <script src="https://cdnjs.cloudflare.com"></script>
    
    <style>
        body { background: #000; color: #00ff00; font-family: 'Courier New', Courier, monospace; text-align: center; margin: 0; }
        #setup-screen { padding: 50px 20px; }
        .input-group { margin: 20px; }
        input { background: #000; border: 1px solid #0f0; color: #0f0; padding: 10px; width: 200px; text-align: center; }
        button { background: #0f0; color: #000; border: none; padding: 10px 25px; cursor: pointer; font-weight: bold; }
        #radar-screen { display: none; }
        #info-panel { padding: 10px; font-size: 12px; border-bottom: 1px solid #333; }
        .radar-canvas { position: relative; margin: 20px auto; }
    </style>
</head>
<body>

    <!-- 登錄畫面 -->
    <div id="setup-screen">
        <h1>RADAR SYSTEM</h1>
        <div class="input-group">
            <p>請輸入房間密碼 (雙方須一致)</p>
            <input type="text" id="roomCode" placeholder="例如: 5201314">
        </div>
        <div class="input-group">
            <p>你的代號</p>
            <input type="text" id="userName" placeholder="例如: 小明">
        </div>
        <!-- 確保 onclick="startRadar()" 在這裡 -->
        <button onclick="startRadar()">啟動掃描器</button>
    </div>

    <!-- 雷達畫面 -->
    <div id="radar-screen">
        <div id="info-panel">偵測中...</div>
        <div id="canvas-holder"></div>
        <div style="margin-top: 20px;">
            <p id="dist-text">尋找訊號中...</p>
            <button onclick="location.reload()" style="background:transparent; color:#f00; border:1px solid #f00;">切換頻道</button>
        </div>
    </div>

    <script>
        // --- 1. Firebase 初始化 ---
        const firebaseConfig = {
            apiKey: "AIzaSyCnw0v8T5Uw0iQWz2HL1dEEuxRILzILDZw",
            databaseURL: "https://findyou-483a9.firebaseio.com", // <-- 已修正為正確格式
            projectId: "findyou-483a9",
        };
        
        let database;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
        } catch (e) {
            console.error("Firebase 初始化失敗，請檢查配置。", e);
            document.getElementById('info-panel').innerText = "錯誤: Firebase 配置無效，無法同步位置。";
        }

        let roomID, myName;
        let myPos = { lat: 0, lon: 0 };
        let peerPos = { lat: 0, lon: 0 };
        let peerName = "等待對方加入...";

        // --- 2. 啟動程序 ---
        function startRadar() {
            roomID = document.getElementById('roomCode').value;
            myName = document.getElementById('userName').value;

            if (!roomID || !myName) return alert("請填寫完整資訊");
            // 這裡捕獲你截圖中的錯誤訊息
            if (!database) {
                alert("伺服器連線失敗,請檢查Firebase 配置或連線狀態。");
                return;
            }

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('radar-screen').style.display = 'block';

            // 請求 GPS 定位
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(onSuccess, onError, {
                    enableHighAccuracy: true,
                    maximumAge: 1000
                });
            } else {
                alert("你的瀏覽器不支援 GPS 定位。");
            }

            // 監聽 Firebase 數據
            database.ref('rooms/' + roomID).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    for (let key in data) {
                        if (key !== myName) {
                            peerPos.lat = data[key].lat;
                            peerPos.lon = data[key].lon;
                            peerName = key;
                        }
                    }
                }
            });
        }

        function onSuccess(position) {
            myPos.lat = position.coords.latitude;
            myPos.lon = position.coords.longitude;
            
            // 上傳位置到 Firebase
            if (database) {
                database.ref('rooms/' + roomID + '/' + myName).set({
                    lat: myPos.lat,
                    lon: myPos.lon,
                    timestamp: Date.now()
                });
            }
            // 已修正使用反引號
            document.getElementById('info-panel').innerText = `座標同步中: ${myPos.lat.toFixed(5)}, ${myPos.lon.toFixed(5)}`;
        }

        function onError(err) {
            alert("請確保開啟 GPS 定位及使用 HTTPS 訪問權限，錯誤碼: " + err.code);
        }

        // --- 3. 雷達繪製 (P5.js) ---
        function setup() {
            let canvas = createCanvas(320, 320);
            canvas.parent('canvas-holder');
            angleMode(DEGREES);
        }

        function draw() {
            background(0, 15); // 雷達殘影
            translate(width / 2, height / 2);

            // 畫雷達圈
            stroke(0, 255, 0, 80);
            noFill();
            ellipse(0, 0, 100);
            ellipse(0, 0, 200);
            ellipse(0, 0, 300);

            // 畫掃描線
            let scanAngle = frameCount * 3 % 360;
            stroke(0, 255, 0);
            line(0, 0, 150 * cos(scanAngle), 150 * sin(scanAngle));

            // 計算對方相對位置 (簡化版：經緯度差距放大)
            if (peerPos.lat !== 0 && myPos.lat !== 0) {
                let dx = (peerPos.lon - myPos.lon) * 100000; // 經度差距
                let dy = (peerPos.lat - myPos.lat) * 100000; // 緯度差距

                // 限制在雷達圈內
                let targetX = constrain(dx, -140, 140);
                let targetY = constrain(-dy, -140, 140); // 緯度 Y 軸相反

                // 畫對方點
                fill(255, 0, 0);
                noStroke();
                ellipse(targetX, targetY, 12, 12);
                fill(0, 255, 0);
                text(peerName, targetX + 10, targetY);

                // 計算距離 (大概值)
                let d = dist(myPos.lat, myPos.lon, peerPos.lat, peerPos.lon) * 111320; 
                // 已修正使用反引號
                document.getElementById('dist-text').innerText = `距離對方約: ${Math.round(d)} 米`;
            }
        }
    </script>
</body>
</html>
